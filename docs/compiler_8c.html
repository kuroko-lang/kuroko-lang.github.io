<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=9"/>
    <meta name="generator" content="Doxygen 1.8.17"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="tabs-override.css">
    <link rel="stylesheet" href="doxy.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <title>Docs | Kuroko</title>
    <script src="/src-min/ace.js"></script>
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
    <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  </head>
  <body>
  <!-- Bootstrap nav bar -->
    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
      <div class="container-fluid">
        <div class="collapse navbar-collapse" id="navbarCollapse">
          <ul class="navbar-nav ms-auto mb-2 mb-md-0">
            <li class="nav-item">
              <a class="nav-link force-cursor" href="/?r=y&c=tutorial()">Tutorial</a>
            </li>
            <li class="nav-item">
              <a class="nav-link force-cursor" href="/ide/">IDE</a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="/" id="navbarDropdown">
                Examples
              </a>
            </li>
          </ul>
        </div>
        <div class="mx-auto order-0" style="padding-left: 2rem; padding-right: 2rem">
          <a class="navbar-brand" href="/">
            <img src="/logo.png" style="height: 2rem; padding-right: 0.5rem;">
            Kuroko
          </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
        </div>
        <div class="collapse navbar-collapse" id="navbarCollapse">
          <ul class="navbar-nav me-auto mb-2 mb-md-0">
            <li class="nav-item">
              <a class="nav-link" href="https://github.com/kuroko-lang/kuroko">Github</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://github.com/kuroko-lang/kuroko/releases">Downloads</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="/docs/">Docs</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- End Bootstrap nav bar -->
    <main class="order-1 container" id="main-content">
      <div id="top">
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Structures</a> &#124;
<a href="#define-members">Macros</a> &#124;
<a href="#typedef-members">Typedefs</a> &#124;
<a href="#enum-members">Enumerations</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">compiler.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Single-pass bytecode compiler.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;assert.h&gt;</code><br />
<code>#include &lt;stdio.h&gt;</code><br />
<code>#include &lt;stdlib.h&gt;</code><br />
<code>#include &lt;string.h&gt;</code><br />
<code>#include &lt;sys/types.h&gt;</code><br />
<code>#include &lt;<a class="el" href="kuroko_8h_source.html">kuroko/kuroko.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="compiler_8h_source.html">kuroko/compiler.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="memory_8h_source.html">kuroko/memory.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="scanner_8h_source.html">kuroko/scanner.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="object_8h_source.html">kuroko/object.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="debug_8h_source.html">kuroko/debug.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="vm_8h_source.html">kuroko/vm.h</a>&gt;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for compiler.c:</div>
<div class="dyncontent">
<div class="center"><img src="compiler_8c__incl.png" border="0" usemap="#src_2compiler_8c" alt=""/></div>
<map name="src_2compiler_8c" id="src_2compiler_8c">
<area shape="rect" title="Single&#45;pass bytecode compiler." alt="" coords="690,5,803,32"/>
<area shape="rect" title=" " alt="" coords="5,80,80,107"/>
<area shape="rect" title=" " alt="" coords="1184,453,1251,480"/>
<area shape="rect" title=" " alt="" coords="338,528,409,555"/>
<area shape="rect" title=" " alt="" coords="442,453,513,480"/>
<area shape="rect" title=" " alt="" coords="1115,229,1211,256"/>
<area shape="rect" href="kuroko_8h.html" title="Top&#45;level header with configuration macros." alt="" coords="551,453,678,480"/>
<area shape="rect" href="compiler_8h.html" title="Exported methods for the source compiler." alt="" coords="521,155,660,181"/>
<area shape="rect" href="object_8h.html" title="Struct definitions for core object types." alt="" coords="512,229,587,256"/>
<area shape="rect" href="memory_8h.html" title="Functions for dealing with garbage collection and memory allocation." alt="" coords="362,155,497,181"/>
<area shape="rect" href="scanner_8h.html" title="Definitions used by the token scanner." alt="" coords="1128,80,1261,107"/>
<area shape="rect" href="debug_8h.html" title="Functions for debugging bytecode execution." alt="" coords="735,80,857,107"/>
<area shape="rect" href="vm_8h.html" title="Core API for the bytecode virtual machine." alt="" coords="851,155,906,181"/>
<area shape="rect" title=" " alt="" coords="627,528,698,555"/>
<area shape="rect" title=" " alt="" coords="528,528,603,555"/>
<area shape="rect" href="value_8h.html" title="Definitions for primitive stack references." alt="" coords="605,379,675,405"/>
<area shape="rect" href="chunk_8h.html" title="Structures and enums for bytecode chunks." alt="" coords="655,304,729,331"/>
<area shape="rect" href="table_8h.html" title="Implementation of a generic hash table." alt="" coords="463,304,529,331"/>
<area shape="rect" title=" " alt="" coords="155,453,239,480"/>
<area shape="rect" href="threads_8h.html" title="Convience header for providing atomic operations to threads." alt="" coords="244,379,327,405"/>
<area shape="rect" title=" " alt="" coords="264,453,336,480"/>
<area shape="rect" title=" " alt="" coords="965,229,1040,256"/>
<area shape="rect" title=" " alt="" coords="763,229,827,256"/>
<area shape="rect" title=" " alt="" coords="851,229,941,256"/>
</map>
</div>
</div>
<p><a href="compiler_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structParser.html">Parser</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structParseRule.html">ParseRule</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structLocal.html">Local</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structUpvalue.html">Upvalue</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structIndexWithNext.html">IndexWithNext</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structLoopExit.html">LoopExit</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structCompiler.html">Compiler</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structClassCompiler.html">ClassCompiler</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a7b54f2cabbdfa0d5ed437d3746209e12"><td class="memItemLeft" align="right" valign="top"><a id="a7b54f2cabbdfa0d5ed437d3746209e12"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>currentChunk</b>()&#160;&#160;&#160;(&amp;current-&gt;codeobject-&gt;chunk)</td></tr>
<tr class="separator:a7b54f2cabbdfa0d5ed437d3746209e12"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a433903dadb8416c8f81f2f770fb4ebeb"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><b>EMIT_CONSTANT_OP</b>(opc,  arg)</td></tr>
<tr class="separator:a433903dadb8416c8f81f2f770fb4ebeb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a196e029eb2adc9808b1e6928e3e1ce23"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><b>WRITE</b>(s)</td></tr>
<tr class="separator:a196e029eb2adc9808b1e6928e3e1ce23"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a24a742a715a9dbe2cb517df0ca218d47"><td class="memItemLeft" align="right" valign="top"><a id="a24a742a715a9dbe2cb517df0ca218d47"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>raiseSyntaxError</b>(token, ...)&#160;&#160;&#160;do { if (parser.panicMode) break; <a class="el" href="vm_8h.html#a91c57f379018d1ce7efca0a406e35431">krk_runtimeError</a>(vm.exceptions-&gt;syntaxError, __VA_ARGS__); finishError(token); } while (0)</td></tr>
<tr class="separator:a24a742a715a9dbe2cb517df0ca218d47"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a259aac00ed43fd7ac58196b770963525"><td class="memItemLeft" align="right" valign="top"><a id="a259aac00ed43fd7ac58196b770963525"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>error</b>(...)&#160;&#160;&#160;raiseSyntaxError(&amp;parser.previous, __VA_ARGS__)</td></tr>
<tr class="separator:a259aac00ed43fd7ac58196b770963525"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a98176ac05ecd75c009723d5a6d4a12dd"><td class="memItemLeft" align="right" valign="top"><a id="a98176ac05ecd75c009723d5a6d4a12dd"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>errorAtCurrent</b>(...)&#160;&#160;&#160;raiseSyntaxError(&amp;parser.current, __VA_ARGS__)</td></tr>
<tr class="separator:a98176ac05ecd75c009723d5a6d4a12dd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a84b563276d7c5f9a4343b91deb165fe5"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><b>ATTACH_PROPERTY</b>(propName,  how,  propValue)</td></tr>
<tr class="separator:a84b563276d7c5f9a4343b91deb165fe5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1488ae537f662875e728a8a2d96695a6"><td class="memItemLeft" align="right" valign="top"><a id="a1488ae537f662875e728a8a2d96695a6"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>EXIT_JUMP_MAX</b>&#160;&#160;&#160;32</td></tr>
<tr class="separator:a1488ae537f662875e728a8a2d96695a6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a48d1976010ce166b81fa3462583a4e96"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><b>PUSH_CHAR</b>(c)</td></tr>
<tr class="separator:a48d1976010ce166b81fa3462583a4e96"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adeef499e230c9bc1f01afbbae216fb32"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><b>PUSH_HEX</b>(n,  type)</td></tr>
<tr class="separator:adeef499e230c9bc1f01afbbae216fb32"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a72b15a0fb5a174e116ebb784f9dfb6d9"><td class="memItemLeft" align="right" valign="top"><a id="a72b15a0fb5a174e116ebb784f9dfb6d9"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>OP_NONE_LONG</b>&#160;&#160;&#160;-1</td></tr>
<tr class="separator:a72b15a0fb5a174e116ebb784f9dfb6d9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acb7a7a5121f8b0fc5c00cda60f64ea3c"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><b>DO_VARIABLE</b>(opset,  opget,  opdel)</td></tr>
<tr class="separator:acb7a7a5121f8b0fc5c00cda60f64ea3c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad6c6834c3abc1f712b7cc21df7a548c8"><td class="memItemLeft" align="right" valign="top"><a id="ad6c6834c3abc1f712b7cc21df7a548c8"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>RULE</b>(token,  a,  b,  c)&#160;&#160;&#160;[token] = {a, b, c}</td></tr>
<tr class="separator:ad6c6834c3abc1f712b7cc21df7a548c8"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr class="memitem:aa7ffb002ed975e6b04f342d466b328df"><td class="memItemLeft" align="right" valign="top"><a id="aa7ffb002ed975e6b04f342d466b328df"></a>
typedef void(*&#160;</td><td class="memItemRight" valign="bottom"><b>ParseFn</b>) (int)</td></tr>
<tr class="separator:aa7ffb002ed975e6b04f342d466b328df"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a59d46fe4edc33c8cc818e3aced56de29"><td class="memItemLeft" align="right" valign="top"><a id="a59d46fe4edc33c8cc818e3aced56de29"></a>
typedef struct <a class="el" href="structCompiler.html">Compiler</a>&#160;</td><td class="memItemRight" valign="bottom"><b>Compiler</b></td></tr>
<tr class="separator:a59d46fe4edc33c8cc818e3aced56de29"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac2ceaa6082b504b725bc6dd33d1d5f22"><td class="memItemLeft" align="right" valign="top"><a id="ac2ceaa6082b504b725bc6dd33d1d5f22"></a>
typedef struct <a class="el" href="structClassCompiler.html">ClassCompiler</a>&#160;</td><td class="memItemRight" valign="bottom"><b>ClassCompiler</b></td></tr>
<tr class="separator:ac2ceaa6082b504b725bc6dd33d1d5f22"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="enum-members"></a>
Enumerations</h2></td></tr>
<tr class="memitem:aa4e7d1a473d0280792d98ddb184d3006"><td class="memItemLeft" align="right" valign="top"><a id="aa4e7d1a473d0280792d98ddb184d3006"></a>enum &#160;</td><td class="memItemRight" valign="bottom"><b>Precedence</b> { <br />
&#160;&#160;<b>PREC_NONE</b>, 
<b>PREC_ASSIGNMENT</b>, 
<b>PREC_COMMA</b>, 
<b>PREC_MUST_ASSIGN</b>, 
<br />
&#160;&#160;<b>PREC_CAN_ASSIGN</b>, 
<b>PREC_TERNARY</b>, 
<b>PREC_OR</b>, 
<b>PREC_AND</b>, 
<br />
&#160;&#160;<b>PREC_NOT</b>, 
<b>PREC_COMPARISON</b>, 
<b>PREC_BITOR</b>, 
<b>PREC_BITXOR</b>, 
<br />
&#160;&#160;<b>PREC_BITAND</b>, 
<b>PREC_SHIFT</b>, 
<b>PREC_TERM</b>, 
<b>PREC_FACTOR</b>, 
<br />
&#160;&#160;<b>PREC_UNARY</b>, 
<b>PREC_BITUNARY</b>, 
<b>PREC_EXPONENT</b>, 
<b>PREC_SUBSCRIPT</b>, 
<br />
&#160;&#160;<b>PREC_CALL</b>, 
<b>PREC_PRIMARY</b>
<br />
 }</td></tr>
<tr class="separator:aa4e7d1a473d0280792d98ddb184d3006"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a42a11575cc237e37732d560240e04371"><td class="memItemLeft" align="right" valign="top"><a id="a42a11575cc237e37732d560240e04371"></a>enum &#160;</td><td class="memItemRight" valign="bottom"><b>FunctionType</b> { <br />
&#160;&#160;<b>TYPE_FUNCTION</b>, 
<b>TYPE_MODULE</b>, 
<b>TYPE_METHOD</b>, 
<b>TYPE_INIT</b>, 
<br />
&#160;&#160;<b>TYPE_LAMBDA</b>, 
<b>TYPE_STATIC</b>, 
<b>TYPE_PROPERTY</b>, 
<b>TYPE_CLASS</b>, 
<br />
&#160;&#160;<b>TYPE_CLASSMETHOD</b>
<br />
 }</td></tr>
<tr class="separator:a42a11575cc237e37732d560240e04371"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:acab3272031ba406c0aa9ce777a50ce77"><td class="memItemLeft" align="right" valign="top"><a class="el" href="structKrkCodeObject.html">KrkCodeObject</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="compiler_8c.html#acab3272031ba406c0aa9ce777a50ce77">krk_compile</a> (const char *src, char *fileName)</td></tr>
<tr class="memdesc:acab3272031ba406c0aa9ce777a50ce77"><td class="mdescLeft">&#160;</td><td class="mdescRight">Compile a string to a code object.  <a href="compiler_8c.html#acab3272031ba406c0aa9ce777a50ce77">More...</a><br /></td></tr>
<tr class="separator:acab3272031ba406c0aa9ce777a50ce77"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a89722e8b88cad3e99af005bbf750e55b"><td class="memItemLeft" align="right" valign="top"><a id="a89722e8b88cad3e99af005bbf750e55b"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="compiler_8c.html#a89722e8b88cad3e99af005bbf750e55b">krk_markCompilerRoots</a> ()</td></tr>
<tr class="memdesc:a89722e8b88cad3e99af005bbf750e55b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Mark objects owned by the compiler as in use. <br /></td></tr>
<tr class="separator:a89722e8b88cad3e99af005bbf750e55b"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a003a23e5dd1b68446f27a7a866f736bc"><td class="memItemLeft" align="right" valign="top"><a id="a003a23e5dd1b68446f27a7a866f736bc"></a>
<a class="el" href="structParseRule.html">ParseRule</a>&#160;</td><td class="memItemRight" valign="bottom"><b>krk_parseRules</b> []</td></tr>
<tr class="separator:a003a23e5dd1b68446f27a7a866f736bc"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Single-pass bytecode compiler. </p>
<p>Kuroko's compiler is still very reminiscent of its CLox roots and uses the same parsing strategy, so if you have read the third chapter of Bob's "Crafting Interpreters", this should should be fairly easy to understand. One important thing that Kuroko's compiler does differently is implement rewinding, which allows for conservative reparsing and recompilation of subexpressions that have already been parsed. This is used to compile ternaries, multiple assignments, and the expression value in generator and comprehension expressions.</p>
<p>Kuroko has several levels of parse precedence, including three different levels indicative of assignments. Most expressions start from the TERNARY or COMMA level, but top-level expression statements and assignment values start at the highest level of ASSIGNMENT, which allows for multiple assignment targets. Expressions parsed from the MUST_ASSIGN level are assignment targets in a multiple assignment. Expression parsed from the CAN_ASSIGN level are single assignment targets.</p>
<p>String compilation manages escape sequence processing, so string tokens received from the scanner are not directly converted to string constants. F-strings are compiled as expressions generating a regular string.</p>
<p>Kuroko's bytecode supports variable operand sizes using paired "short" and "long" opcodes. To ease the output of these opcodes, the EMIT_CONSTANT_OP macro will generate the appropriate opcode given an operand. </p>

<p class="definition">Definition in file <a class="el" href="compiler_8c_source.html">compiler.c</a>.</p>
</div><h2 class="groupheader">Macro Definition Documentation</h2>
<a id="a84b563276d7c5f9a4343b91deb165fe5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a84b563276d7c5f9a4343b91deb165fe5">&#9670;&nbsp;</a></span>ATTACH_PROPERTY</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define ATTACH_PROPERTY</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">propName, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">how, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">propValue&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">    <span class="keywordflow">do</span> { \</div>
<div class="line">    KrkToken val_tok = syntheticToken(propValue); \</div>
<div class="line">    size_t val_ind = identifierConstant(&amp;val_tok); \</div>
<div class="line">    EMIT_CONSTANT_OP(how, val_ind); \</div>
<div class="line">    KrkToken name_tok = syntheticToken(propName); \</div>
<div class="line">    size_t name_ind = identifierConstant(&amp;name_tok); \</div>
<div class="line">    EMIT_CONSTANT_OP(OP_CLASS_PROPERTY, name_ind); \</div>
<div class="line">} <span class="keywordflow">while</span> (0)</div>
</div><!-- fragment -->
<p class="definition">Definition at line <a class="el" href="compiler_8c_source.html#l01247">1247</a> of file <a class="el" href="compiler_8c_source.html">compiler.c</a>.</p>

</div>
</div>
<a id="acb7a7a5121f8b0fc5c00cda60f64ea3c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acb7a7a5121f8b0fc5c00cda60f64ea3c">&#9670;&nbsp;</a></span>DO_VARIABLE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DO_VARIABLE</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">opset, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">opget, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">opdel&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">    <span class="keywordflow">do</span> { \</div>
<div class="line">    if (canAssign == 2) { \</div>
<div class="line">        if (matchComplexEnd()) { \</div>
<div class="line">            EMIT_CONSTANT_OP(opset, arg); \</div>
<div class="line">            break; \</div>
<div class="line">        } \</div>
<div class="line">        canAssign = 0; \</div>
<div class="line">    } \</div>
<div class="line">    if (canAssign &amp;&amp; match(TOKEN_EQUAL)) { \</div>
<div class="line">        parsePrecedence(PREC_ASSIGNMENT); \</div>
<div class="line">        EMIT_CONSTANT_OP(opset, arg); \</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (canAssign &amp;&amp; matchAssignment()) { \</div>
<div class="line">        EMIT_CONSTANT_OP(opget, arg); \</div>
<div class="line">        assignmentValue(); \</div>
<div class="line">        EMIT_CONSTANT_OP(opset, arg); \</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (inDel &amp;&amp; matchEndOfDel()) {\</div>
<div class="line">        if (opdel == OP_NONE || !canAssign || inDel != 1) { error(<span class="stringliteral">&quot;Invalid del target&quot;</span>); } <span class="keywordflow">else</span> { \</div>
<div class="line">        EMIT_CONSTANT_OP(opdel, arg); inDel = 2; } \</div>
<div class="line">    } <span class="keywordflow">else</span> { \</div>
<div class="line">        EMIT_CONSTANT_OP(opget, arg); \</div>
<div class="line">    } } <span class="keywordflow">while</span> (0)</div>
</div><!-- fragment -->
<p class="definition">Definition at line <a class="el" href="compiler_8c_source.html#l02310">2310</a> of file <a class="el" href="compiler_8c_source.html">compiler.c</a>.</p>

</div>
</div>
<a id="a433903dadb8416c8f81f2f770fb4ebeb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a433903dadb8416c8f81f2f770fb4ebeb">&#9670;&nbsp;</a></span>EMIT_CONSTANT_OP</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define EMIT_CONSTANT_OP</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">opc, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">arg&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">    <span class="keywordflow">do</span> { <span class="keywordflow">if</span> (arg &lt; 256) { emitBytes(opc, arg); } \</div>
<div class="line">    else { emitBytes(opc ## _LONG, arg &gt;&gt; 16); emitBytes(arg &gt;&gt; 8, arg); } } <span class="keywordflow">while</span> (0)</div>
</div><!-- fragment -->
<p class="definition">Definition at line <a class="el" href="compiler_8c_source.html#l00160">160</a> of file <a class="el" href="compiler_8c_source.html">compiler.c</a>.</p>

</div>
</div>
<a id="a48d1976010ce166b81fa3462583a4e96"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a48d1976010ce166b81fa3462583a4e96">&#9670;&nbsp;</a></span>PUSH_CHAR</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define PUSH_CHAR</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">c</td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">        <span class="keywordflow">do</span> { <span class="keywordflow">if</span> (stringCapacity &lt; stringLength + 1) { \</div>
<div class="line">        size_t old = stringCapacity; stringCapacity = GROW_CAPACITY(old); \</div>
<div class="line">        stringBytes = GROW_ARRAY(<span class="keywordtype">char</span>, stringBytes, old, stringCapacity); \</div>
<div class="line">    } stringBytes[stringLength++] = c; } <span class="keywordflow">while</span> (0)</div>
</div><!-- fragment -->
</div>
</div>
<a id="adeef499e230c9bc1f01afbbae216fb32"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adeef499e230c9bc1f01afbbae216fb32">&#9670;&nbsp;</a></span>PUSH_HEX</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define PUSH_HEX</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">n, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">type&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">    <span class="keywordflow">do</span> { \</div>
<div class="line">    char tmpbuf[10] = {0}; \</div>
<div class="line">    for (<span class="keywordtype">size_t</span> i = 0; i &lt; n; ++i) { \</div>
<div class="line">        if (c + i + 2 == end || !isHex(c[i+2])) { \</div>
<div class="line">            error(<span class="stringliteral">&quot;truncated \\%c escape&quot;</span>, type); \</div>
<div class="line">            FREE_ARRAY(<span class="keywordtype">char</span>,stringBytes,stringCapacity); \</div>
<div class="line">            return; \</div>
<div class="line">        } \</div>
<div class="line">        tmpbuf[i] = c[i+2]; \</div>
<div class="line">    } \</div>
<div class="line">    unsigned <span class="keywordtype">long</span> value = strtoul(tmpbuf, NULL, 16); \</div>
<div class="line">    if (value &gt;= 0x110000) { \</div>
<div class="line">        error(<span class="stringliteral">&quot;invalid codepoint in \\%c escape&quot;</span>, type); \</div>
<div class="line">    } \</div>
<div class="line">    if (isBytes) { \</div>
<div class="line">        PUSH_CHAR(value); \</div>
<div class="line">        break; \</div>
<div class="line">    } \</div>
<div class="line">    unsigned <span class="keywordtype">char</span> bytes[5] = {0}; \</div>
<div class="line">    size_t len = <a class="code" href="structKrkString.html#afd3c39c1c8d8c9363c767e5038a53b8e">krk_codepointToBytes</a>(value, bytes); \</div>
<div class="line">    for (<span class="keywordtype">size_t</span> i = 0; i &lt; len; i++) PUSH_CHAR(bytes[i]); \</div>
<div class="line">} <span class="keywordflow">while</span> (0)</div>
</div><!-- fragment -->
</div>
</div>
<a id="a196e029eb2adc9808b1e6928e3e1ce23"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a196e029eb2adc9808b1e6928e3e1ce23">&#9670;&nbsp;</a></span>WRITE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define WRITE</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">s</td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">    <span class="keywordflow">do</span> { \</div>
<div class="line">    size_t len = strlen(s); \</div>
<div class="line">    if (writer - len &lt; space) <span class="keywordflow">break</span>; \</div>
<div class="line">    writer -= len; \</div>
<div class="line">    memcpy(writer, s, len); \</div>
<div class="line">} <span class="keywordflow">while</span> (0)</div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="acab3272031ba406c0aa9ce777a50ce77"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acab3272031ba406c0aa9ce777a50ce77">&#9670;&nbsp;</a></span>krk_compile()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structKrkCodeObject.html">KrkCodeObject</a>* krk_compile </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>src</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>fileName</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Compile a string to a code object. </p>
<p>Compiles the source string 'src' into a code object.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">src</td><td>Source code string to compile. </td></tr>
    <tr><td class="paramname">fileName</td><td>Path name of the source file or a representative string like "&lt;stdin&gt;" </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>The code object resulting from the compilation, or NULL if compilation failed. </dd></dl>

<p class="definition">Definition at line <a class="el" href="compiler_8c_source.html#l03137">3137</a> of file <a class="el" href="compiler_8c_source.html">compiler.c</a>.</p>

</div>
</div>
</div><!-- contents -->
<div class="ttc" id="astructKrkString_html_afd3c39c1c8d8c9363c767e5038a53b8e"><div class="ttname"><a href="structKrkString.html#afd3c39c1c8d8c9363c767e5038a53b8e">KrkString::krk_codepointToBytes</a></div><div class="ttdeci">size_t krk_codepointToBytes(krk_integer_type value, unsigned char *out)</div><div class="ttdoc">Convert an integer codepoint to a UTF-8 byte representation.</div><div class="ttdef"><b>Definition:</b> <a href="object_8c_source.html#l00035">object.c:35</a></div></div>
      <footer class="container text-center mb-3">
        <p class="mb-0">Copyright 2020-2021 <a href="https://github.com/klange">K. Lange</a></p>
        <p class="mb-0">Generated by <a href="http://www.doxygen.org/index.html"><img class="footer" style="height: 20px;" src="doxygen.png" alt="doxygen"/></a> 1.8.17</p>
      </footer>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
  </body>
</html>
